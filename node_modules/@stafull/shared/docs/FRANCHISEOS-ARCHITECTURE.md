# FranchiseOS - Complete Module Architecture

## Overview
**Version:** 1.0 | **Updated:** 2026-01-19 | **Status:** APPROVED

> **MANDATORY:** This document defines the complete FranchiseOS module architecture. All portals and modules MUST follow this specification.

---

## Multi-Repo Architecture

```
C:\StaFull\
├── stafull-shared/           # NPM package - design tokens, components, rules
├── stafull-core-engine/      # Express API hub (port 3001)
├── stafull-portal-hq/        # HQ Portal - Network Command Center (port 5174)
├── stafull-portal-franchise/ # Owner + Management Portals (port 5175)
├── stafull-portal-driver/    # Driver Co-Pilot tablet app (port 5176)
└── stafull-portal-customer/  # Customer portals (port 5177)
```

### Connection Diagram

```
                    ┌─────────────────────┐
                    │  @stafull/shared    │
                    │  (npm package)      │
                    │  - Design tokens    │
                    │  - Components       │
                    │  - Global rules     │
                    └──────────┬──────────┘
                               │ npm install
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
        ▼                      ▼                      ▼
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ portal-hq     │    │portal-franchise│   │ portal-driver │
│ (React app)   │    │ (React app)   │    │ (React app)   │
└───────┬───────┘    └───────┬───────┘    └───────┬───────┘
        │                    │                    │
        │ REST/WebSocket     │                    │
        │                    ▼                    │
        │           ┌───────────────┐             │
        └──────────▶│ core-engine   │◀────────────┘
                    │ (Express API) │
                    │ (PostgreSQL)  │
                    │ (Socket.io)   │
                    └───────────────┘
```

---

## CORE AI ENGINE MODULE

### Automation Level: 99.9%

### 1. Data Ingestion Layer
- **Vehicle Telemetry**
  - GPS coordinates (real-time, 5-second intervals)
  - Fuel level sensors (continuous monitoring)
  - Vehicle diagnostics (OBD-II data stream)
  - Battery charge status (for EV vans)
  - Equipment sensor status (pumps, safety switches)
- **Operational Data**
  - Delivery completion events
  - Fuel consumption per delivery
  - Customer location coordinates
  - Traffic pattern data (integrated APIs)
  - Weather conditions (real-time API)
- **Customer Data**
  - Subscription details and tiers
  - Delivery preferences and schedules
  - Payment history and patterns
  - CSAT feedback scores
  - Communication preferences

### 2. Processing & Analysis Layer
- **Route Optimization Engine**
  - Density-based clustering algorithm
  - Time-window optimization
  - Traffic-aware rerouting
  - Fuel efficiency calculations
  - Driver break scheduling
- **Predictive Analytics**
  - Subscriber churn prediction
  - Demand forecasting by neighborhood
  - Price optimization modeling
  - Equipment maintenance prediction
  - Safety risk assessment
- **Compliance Monitoring**
  - Local regulation database
  - Permit expiration tracking
  - Safety protocol verification
  - Insurance requirement monitoring
  - Environmental regulation compliance

### 3. Output & Action Layer
- **Automated Dispatch Plans**
  - Daily delivery schedules (99.9% automated)
  - Dynamic rerouting instructions
  - Priority delivery flagging
  - Resource allocation recommendations
  - Exception handling protocols
- **Insight Generation**
  - Franchise health scoring
  - Driver performance metrics
  - Customer satisfaction trends
  - Operational efficiency reports
  - Financial performance predictions

---

## HQ PORTAL MODULE - "Network Command Center"

### Dashboard Card Count: 10

### Layout Structure (Asymmetric)

**Top Row:**
- **Large Map (2/3 width):** National delivery map with live vehicle tracking
- **Tall Narrow Card (1/3 width):** National CSAT Score (big bold number, trend indicator)

**Middle Row:**
- **Medium Card:** Franchise Health (list of franchises with health scores)
- **Small Card:** AI Performance (model accuracy stats)
- **Medium Card:** Brand Compliance (compliance rates, violations)

**Bottom Row:**
- **Medium Card:** Safety & Insurance (incident alerts, driver scores)
- **Wide Card:** Financial Oversight (revenue trends, royalty collection)
- **Small Card:** Support Center (open tickets, AI chat)

### 1. Network Operations Dashboard
- **Real-Time Monitoring**
  - National delivery map with live vehicle tracking
  - CSAT heatmap by territory
  - Safety incident alert center
  - System-wide performance metrics
  - Weather impact visualization
- **Franchise Health Management**
  - Automated health scoring (0-100 scale)
  - KPI benchmarking across franchises
  - Compliance violation tracking
  - Financial stability indicators
  - Customer retention rates by franchise
- **AI Model Management**
  - Routing algorithm performance monitoring
  - Predictive accuracy metrics
  - Model retraining scheduling
  - Data quality assessment tools
  - A/B testing interface for new features

### 2. Brand & Compliance Center
- **Brand Standards Enforcement**
  - Visual brand audit tools (photo analysis)
  - Customer experience consistency monitoring
  - Marketing material approval workflow
  - Training compliance tracking
  - Uniform and vehicle appearance standards
- **Regulatory Oversight**
  - Centralized compliance database
  - Automated regulation updates
  - Franchise audit scheduling
  - Violation tracking and resolution
  - Insurance verification system

### 3. Customer & Market Intelligence
- **National Customer Database**
  - Centralized CRM with full customer history
  - Segmentation and targeting tools
  - Lifetime value calculation
  - Churn prediction dashboard
  - Referral program analytics
- **Market Analysis**
  - Territory performance comparison
  - Competitive intelligence dashboard
  - Pricing strategy analysis
  - Market expansion recommendations
  - Demographic targeting tools

### 4. Franchise Support & Development
- **Onboarding Management**
  - Step-by-step franchise launch workflow
  - Equipment provisioning tracking
  - Training completion monitoring
  - Initial performance benchmarking
  - Support ticket escalation system
- **Performance Coaching**
  - Automated coaching recommendations
  - Best practice sharing platform
  - Peer comparison tools
  - Growth opportunity identification
  - Intervention scheduling for underperformance

---

## FRANCHISEE OWNER PORTAL MODULE - "P&L Cockpit"

### Dashboard Card Count: 8

### Layout Structure (Asymmetric)

**Top Row:**
- **Large Card (2/3 width):** Financial Summary (this week's revenue, net profit, chart)
- **Tall Narrow Card (1/3 width):** Subscriber Hub (active subscribers, retention rate)

**Middle Row:**
- **Medium Card:** Driver Performance (leaderboard, efficiency stats)
- **Small Card:** Royalty & Fees (due to HQ, compliance status)
- **Medium Card:** Fuel Inventory (current levels, next resupply)

**Bottom Row:**
- **Wide Card:** Delivery Efficiency (deliveries/hour, peak times)
- **Small Card:** Compliance Center (next audit date)

### 1. Financial Command Center
- **Real-Time P&L Dashboard**
  - Daily revenue tracking with subscription breakdown
  - Expense categorization (fuel, payroll, maintenance, fees)
  - Cash flow forecasting (30-60-90 day views)
  - Profit margin analysis by customer segment
  - Break-even point tracking
- **Fee Transparency System**
  - Automated royalty calculation (6% of revenue)
  - Brand fund allocation (1% of revenue)
  - AI hardware lease tracking ($600/van/month)
  - Payment scheduling and automation
  - Historical fee analysis and trends
- **Budget & Forecasting**
  - Variable cost prediction based on delivery volume
  - Capital expenditure planning tools
  - Scenario modeling for growth
  - Expense optimization recommendations
  - Tax preparation automation

### 2. Operational Efficiency Hub
- **Density & Delivery Optimization**
  - Subscriber density heatmap
  - Delivery efficiency metrics (deliveries/hour)
  - Route optimization performance tracking
  - Capacity utilization analysis
  - Peak time identification tools
- **Resource Management**
  - Vehicle utilization tracking
  - Driver scheduling optimization
  - Fuel inventory management
  - Equipment maintenance scheduling
  - Supply chain coordination for refueling

### 3. Customer Relationship Management
- **Subscriber Lifecycle Management**
  - Acquisition cost tracking by channel
  - Retention rate monitoring
  - Churn prediction with intervention triggers
  - Upsell/cross-sell opportunity identification
  - Customer satisfaction trend analysis
- **Service Quality Monitoring**
  - Real-time CSAT dashboard
  - Delivery accuracy tracking
  - Response time to customer issues
  - Service level agreement compliance
  - Customer communication logs

### 4. Compliance & Safety Management
- **Local Regulation Compliance**
  - Automated permit renewal reminders
  - Regulation change notifications
  - Compliance checklist management
  - Audit preparation tools
  - Violation tracking and resolution
- **Safety Program Administration**
  - Incident reporting and analysis
  - Safety training compliance tracking
  - Vehicle safety inspection scheduling
  - Driver safety score monitoring
  - Insurance requirement verification

---

## MANAGEMENT PORTAL MODULE - "Mission Control"

### Dashboard Card Count: 20

### Layout Structure (Asymmetric)

**Top Row:**
- **Large Card (2/3 width):** Dispatch Console (AI route plan, real-time updates)
- **Tall Narrow Card (1/3 width):** Driver Fleet (on-duty drivers, call-outs)

**Middle Row:**
- **Medium Card:** Safety Operations (incident alerts, driver scores)
- **Small Card:** Customer Comms (unread messages, feedback)
- **Medium Card:** Issue Resolution (active issues, status)

**Bottom Row:**
- **Wide Card:** Schedule Manager (today's schedule, capacity)
- **Small Card:** Vehicle Maintenance (upcoming tasks, status)

### 1. Daily Operations Command Center
- **AI Dispatch Console**
  - Visual route planning interface with drag-and-drop override
  - Real-time vehicle tracking with status indicators
  - Delivery priority management tools
  - Exception handling workflow
  - Communication center for driver coordination
- **Delivery Schedule Management**
  - Time-block optimization (pre-sunrise, morning, mid-day, evening, post-sunset)
  - Customer preference integration
  - Capacity planning tools
  - Schedule adjustment interface
  - Conflict resolution system

### 2. Driver & Fleet Management
- **Performance Monitoring**
  - Real-time driver efficiency metrics
  - "Clean Delivery" score tracking
  - Safety compliance monitoring
  - Customer feedback integration
  - Performance trend analysis
- **Fleet Operations**
  - Vehicle status dashboard
  - Maintenance scheduling and tracking
  - Fuel level monitoring
  - Charging schedule for EV vans
  - Equipment inventory management

### 3. Customer Service Hub
- **Issue Resolution System**
  - Customer complaint tracking
  - Resolution workflow automation
  - Escalation management
  - Customer communication history
  - Satisfaction recovery tools
- **Service Quality Assurance**
  - Delivery accuracy verification
  - Customer feedback collection
  - Service improvement tracking
  - Quality metrics dashboard
  - Training need identification

### 4. Safety & Compliance Operations
- **Real-Time Safety Monitoring**
  - AI camera alert dashboard
  - Safety incident reporting
  - Driver behavior monitoring
  - Vehicle safety status
  - Emergency response coordination
- **Compliance Operations**
  - Daily compliance checklist management
  - Regulation adherence tracking
  - Audit preparation tools
  - Documentation management
  - Reporting automation

---

## DRIVER TABLET APP MODULE - "Co-Pilot"

### Operational Modes: 4

| Mode | Purpose |
|------|---------|
| Parked | Shift start/end, vehicle status |
| Driving | Navigation map (75%), info strip (25%) |
| Delivery | Customer info, fuel type, confirmation |
| Resupply | Tank levels, fill confirmation |

### Design Constraints
- **Landscape tablet ONLY** - No portrait mode
- **NO scrolling** - Use modals for overflow
- Portrait shows "Please rotate device" overlay
- Large touch targets: 48-80px minimum
- Limited buttons for single-finger use
- **NO manual photo buttons** - AI cameras handle all photos automatically

### 1. Delivery Execution Interface
- **Next Delivery Focus Screen**
  - Large display of next customer details
  - Fuel type and amount indicators
  - Customer notes and special instructions
  - Safety perimeter requirements
  - Estimated time and distance
- **Delivery Confirmation System**
  - One-touch delivery start/complete
  - Photo capture for proof of delivery
  - Digital signature collection
  - Issue reporting interface
  - Customer feedback prompt

### 2. Navigation & Routing
- **AI-Powered Navigation**
  - Turn-by-turn directions optimized for delivery efficiency
  - Real-time traffic and hazard alerts
  - Parking and access point guidance
  - Return route optimization
  - Charging station location for EV vans
- **Route Information Display**
  - Full day's delivery schedule
  - Time window indicators
  - Priority delivery highlighting
  - Customer density visualization
  - Efficiency score tracking

### 3. Safety & Compliance Tools
- **Pre-Trip Checklist**
  - Vehicle inspection verification
  - Equipment safety checks
  - Fuel system verification
  - Emergency equipment confirmation
  - Digital signature for compliance
- **In-Cab Safety System**
  - AI camera status monitoring
  - Safety alert display
  - Emergency contact interface
  - Incident reporting tools
  - Safety score feedback

### 4. Performance & Communication
- **Performance Tracking**
  - Real-time efficiency metrics
  - "Clean Delivery" score display
  - Customer satisfaction feedback
  - Safety compliance tracking
  - Bonus calculation preview
- **Communication Center**
  - One-touch contact with management
  - Customer notification interface
  - Issue reporting tools
  - Schedule update notifications
  - Training material access

---

## HR MODULE - "People Operations"

### Automation Level: 90%

### Employer-Facing Dashboard (Franchise Owners/Managers)

**Top Row:**
- **Large Card:** Workforce Overview (total employees, attrition rate)
- **Tall Narrow Card:** Payroll Preview (next payroll, bonus pool)

**Middle Row:**
- **Medium Card:** Training & Development (compliance rates, assigned tasks)
- **Small Card:** Compliance Center (next audit date)

**Bottom Row:**
- **Wide Card:** Performance Management (reviews due, team scores)
- **Small Card:** Recruitment Pipeline (open jobs, applicants)

### Employee-Facing Dashboard

**Top Row:**
- **Medium Card:** Payslip (current net pay, download button)
- **Medium Card:** Schedule (upcoming shifts, swap request)

**Bottom Row:**
- **Small Card:** Benefits Summary (plan, coverage)
- **Small Card:** Performance Score (current score)

### 1. Recruitment & Onboarding (90% Automated)
- **Automated Hiring Pipeline**
  - Job posting generation and distribution
  - Resume screening with AI scoring
  - Background check automation
  - Interview scheduling and coordination
  - Offer letter generation and tracking
- **Digital Onboarding System**
  - Electronic document collection and verification
  - Training schedule automation
  - Equipment assignment tracking
  - System access provisioning
  - Compliance certification management

### 2. Performance & Development
- **Automated Performance Management**
  - KPI tracking integration with operations data
  - Performance review scheduling and automation
  - Development plan generation
  - Training need identification
  - Career progression tracking
- **Training & Certification**
  - Automated training assignment based on performance gaps
  - Certification tracking and renewal reminders
  - Skills inventory management
  - Training effectiveness measurement
  - Compliance training automation

### 3. Payroll & Compensation
- **Automated Payroll Processing**
  - Time tracking integration with delivery data
  - Bonus calculation automation (80% hourly + 0-40% bonus)
  - Tax calculation and filing automation
  - Direct deposit processing
  - Payroll reporting and analytics
- **Compensation Management**
  - Market rate analysis and recommendations
  - Compensation structure management
  - Bonus program administration
  - Benefits enrollment automation
  - Total compensation statements

### 4. Compliance & Workforce Management
- **Regulatory Compliance Automation**
  - Labor law compliance monitoring
  - Work hour tracking and limit enforcement
  - Break requirement compliance
  - Certification and license tracking
  - Audit preparation automation
- **Workforce Planning**
  - Staffing level recommendations based on delivery volume
  - Schedule optimization tools
  - Leave management automation
  - Succession planning tools
  - Workforce analytics dashboard

---

## FINANCE MODULE

### Automation Level: 95%

### 1. Automated Accounting (95% Automated)
- **Transaction Processing**
  - Bank feed integration with automatic categorization
  - Expense receipt capture and processing
  - Invoice generation and tracking
  - Payment processing automation
  - Reconciliation automation
- **Financial Reporting**
  - Real-time P&L statement generation
  - Balance sheet automation
  - Cash flow statement generation
  - Financial ratio calculation
  - Performance benchmarking

### 2. Revenue & Subscription Management
- **Subscription Billing Automation**
  - Tiered pricing management (weekly/bi-weekly/annual)
  - Automated billing and payment collection
  - Failed payment handling automation
  - Refund processing automation
  - Revenue recognition automation
- **Pricing & Discount Management**
  - Dynamic pricing based on fuel costs
  - Discount program administration
  - Promotional pricing management
  - Price guarantee tracking ($0.10 below average)
  - Competitive price analysis

### 3. Expense Management & Optimization
- **Fuel Cost Management**
  - Card-lock station price monitoring
  - Purchase optimization algorithms
  - Fuel cost tracking and analysis
  - Budget vs. actual comparison
  - Cost saving opportunity identification
- **Operational Expense Control**
  - Variable cost tracking and analysis
  - Budget management tools
  - Expense approval workflow automation
  - Vendor management system
  - Cost reduction recommendations

### 4. Tax & Compliance Automation
- **Tax Preparation & Filing**
  - Automated tax calculation
  - Electronic filing system
  - Tax payment scheduling
  - Compliance reporting automation
  - Audit support tools
- **Financial Compliance**
  - Regulatory requirement tracking
  - Compliance reporting automation
  - Internal control monitoring
  - Fraud detection algorithms
  - Financial policy enforcement

---

## CUSTOMER PORTAL MODULE

### Dashboard Card Count: 7

### 1. Account Management
- **Subscription Management**
  - Tier selection and modification (weekly/bi-weekly/annual)
  - Payment method management
  - Billing history and receipts
  - Account upgrade/downgrade tools
  - Cancellation and pause options
- **Profile & Preferences**
  - Vehicle information management
  - Fuel type preferences
  - Delivery schedule customization
  - Communication preferences
  - Special instructions database

### 2. Delivery Management
- **Schedule & Tracking**
  - Upcoming delivery calendar
  - Real-time delivery tracking map
  - Delivery history with details
  - Schedule modification interface
  - Delivery confirmation and feedback
- **Service Management**
  - Additional delivery requests
  - Service issue reporting
  - Special request submission
  - Emergency service coordination
  - Service quality feedback

### 3. Savings & Rewards
- **Cost Tracking**
  - Fuel savings calculator (vs. station prices)
  - Monthly savings reports
  - Price comparison tools
  - Budget tracking features
  - Environmental impact calculator
- **Loyalty Program**
  - Referral tracking and rewards
  - Loyalty point accumulation and redemption
  - Tier benefits display
  - Special offer notifications
  - Reward history tracking

### 4. Support & Communication
- **Help & Support Center**
  - Knowledge base with AI chatbot
  - Support ticket submission
  - FAQ and troubleshooting guides
  - Community forum access
  - Video tutorial library
- **Communication Tools**
  - In-app messaging with customer service
  - Notification preference management
  - Service update announcements
  - Feedback submission tools
  - Survey participation interface

---

## DATA FLOW & INTEGRATION ARCHITECTURE

### 1. Real-Time Data Pipeline
- **Input Streams:**
  - Vehicle telemetry (GPS, sensors, diagnostics)
  - Customer interactions (app usage, feedback)
  - Financial transactions (payments, expenses)
  - Operational events (delivery completions, issues)
  - External data (traffic, weather, fuel prices)
- **Processing Flow:**
  - Data validation and cleaning
  - Real-time aggregation and analysis
  - Pattern recognition and anomaly detection
  - Predictive model updating
  - Action trigger generation
- **Output Streams:**
  - Dashboard updates (real-time visualization)
  - Alert generation (email, SMS, in-app)
  - Report generation (scheduled and on-demand)
  - API responses (for external integrations)
  - Database updates (for historical analysis)

### 2. Module Interconnections
- **Bidirectional Data Flows:**
  - Driver App ↔ Management Portal (real-time status updates)
  - Management Portal ↔ AI Engine (route optimization requests/responses)
  - HR Module ↔ Finance Module (payroll data exchange)
  - Customer Portal ↔ Franchisee Owner Portal (subscription and feedback data)
  - All Modules ↔ HQ Portal (aggregated performance data)
- **Event-Driven Architecture:**
  - Delivery completion triggers billing and CSAT survey
  - Safety incident triggers compliance tracking and management alerts
  - Payment processing triggers financial reporting and royalty calculation
  - Customer feedback triggers performance scoring and intervention workflows
  - Schedule changes trigger route reoptimization and customer notifications

### 3. Automated Workflow Triggers
- **Operational Triggers:**
  - Low fuel level → Automated refuel scheduling
  - High customer density → Route optimization trigger
  - Safety violation → Manager alert and training assignment
  - Subscription renewal → Payment processing and notification
  - Performance threshold → Bonus calculation and payout
- **Business Intelligence Triggers:**
  - Churn risk detection → Retention offer generation
  - Efficiency drop → Process improvement recommendation
  - Cost increase → Budget alert and optimization suggestion
  - Compliance deadline → Automated reminder and workflow initiation
  - Growth opportunity → Expansion recommendation and resource planning

---

## DEPLOYMENT MAP

| Module | Domain | Platform | Port (Dev) |
|--------|--------|----------|------------|
| core-engine | api.stafull.com | Railway | 3001 |
| portal-hq | hq.stafull.com | Vercel | 5174 |
| portal-franchise | franchise.stafull.com | Vercel | 5175 |
| portal-driver | driver.stafull.com | Vercel | 5176 |
| portal-customer | app.stafull.com | Vercel | 5177 |

---

## DESIGN STANDARDS (Source: stafull-design-system)

### Typography
- **Font:** Montserrat ONLY (no Roboto, no Helvetica)
- **Weights:** 400 (regular), 500 (medium), 600 (semibold), 700 (bold)
- **NO ALL CAPS** - Use `text-transform: none` everywhere

### Color Palette
- **Accent Color:** Red #a30000 (glossy gradient: #cc0000 → #a30000 → #8a0000)
- **Background (LIGHTER):** #1e1f22 base with radial gradients
- **Cards (DARKER):** Linear gradient #131416 → #0a0b0d (cards float on lighter background)

### Card Styling (Source: stafull-design-system)
- **Border Radius:** 14px (`--sf-radius-card`)
- **Border:** 1px solid rgba(255, 255, 255, 0.04)
- **Shadow (3-layer):**
  - `0 25px 50px rgba(0, 0, 0, 0.8)` - Deep outer
  - `0 10px 20px rgba(0, 0, 0, 0.6)` - Mid-level
  - `0 1px 0 rgba(255, 255, 255, 0.06) inset` - Top highlight
- **Top Sheen:** 50% height gradient, rgba(255, 255, 255, 0.07) → transparent

### Layout
- **Gap:** 12px (`--sf-gap`) - consistent spacing between all elements
- **Asymmetric by importance** - Cards sized 2/3 + 1/3, large/medium/small
- **NOT equal grids** - Primary content gets more space
- **Dense but balanced** - No wasted space, no clutter

### Focus & Hover States
- **Focus:** `outline: 1px solid #a30000; outline-offset: 0;`
- **Hover:** `outline: 1px solid #a30000; outline-offset: 0;`
- **NEVER** use `outline: 2px` or `outline-offset: 2px`

### Shadows
- **Black only** - No colored shadows (no red rgba in shadows)
- **Glossy elements:** Use `--sf-shadow-glossy` for buttons/pills

---

**THIS FILE IS ENFORCED. ALL MODULES MUST FOLLOW THIS ARCHITECTURE.**

