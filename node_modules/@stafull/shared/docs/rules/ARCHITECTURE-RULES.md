# ARCHITECTURE RULES
## StaFull Platform Architecture - Mandatory Reference
**Version:** 3.2 | **Updated:** 2026-01-24 | **Status:** ENFORCED

> **DESIGN AUTHORITY:** `stafull-design-system/src/stafull-system.css` (HIGHEST)
> **DESIGN RULES:** See `DESIGN-RULES.md` for all visual design specifications
> **MANDATORY:** All agents and developers MUST read this file before ANY architectural decisions.

**This file covers ARCHITECTURE only. For visual design specifications, see DESIGN-RULES.md.**

---

## 1. MODULE ARCHITECTURE (FranchiseOS)

### Core Modules
| Module | Type | Automation | Description |
|--------|------|------------|-------------|
| Core AI Engine | Backend | 99.9% | Data ingestion, route optimization, compliance |
| HQ Portal | Frontend | - | Network operations, brand compliance |
| Franchisee Owner Portal | Frontend | - | P&L Cockpit, financial command center |
| Management Portal | Frontend | - | Mission Control, daily operations |
| Driver Tablet App | Frontend | - | Co-Pilot, 4 operational modes |
| Customer Portal | Frontend | - | Account, delivery, savings management |
| HR Module | Standalone | 90% | People Operations, workforce management |
| Finance Module | Standalone | 95% | Automated accounting, billing, tax |

### Module Data Flow
```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Portal Apps    │────▶│  Core AI Engine │────▶│   PostgreSQL    │
│  (React)        │◀────│  (Express.js)   │◀────│   (Neon)        │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                       │
        ▼                       ▼
┌─────────────────┐     ┌─────────────────┐
│  HR Module      │     │  Finance Module │
│  (90% auto)     │     │  (95% auto)     │
└─────────────────┘     └─────────────────┘
```

---

## 2. REPOSITORY STRUCTURE

```
C:\StaFull\
├── stafull-shared/           # SOURCE OF TRUTH - Design system, tokens, rules
├── stafull-core-engine/      # Core AI Engine - API hub, route optimization
├── stafull-portal-hq/        # HQ Portal - Network Command Center
├── stafull-portal-franchise/ # Owner (P&L Cockpit) + Management (Mission Control)
├── stafull-portal-driver/    # Driver Tablet App - Co-Pilot
└── stafull-portal-customer/  # Customer Portals (residential, B2B, B2C, investor, lender)
```

### Repository Purposes
| Repo | Type | Purpose |
|------|------|---------|
| stafull-shared | NPM Package | Design tokens, components, rules documentation |
| stafull-core-engine | API Service | Core AI Engine - API, database, route optimization, compliance |
| stafull-portal-hq | React App | HQ Portal - Network Command Center |
| stafull-portal-franchise | React App | Owner Portal (P&L Cockpit) + Management Portal (Mission Control) |
| stafull-portal-driver | React App | Driver Tablet App - Co-Pilot with 4 modes |
| stafull-portal-customer | React App | Customer Portals - residential, B2B, B2C, investor, lender

---

## 3. PORT ASSIGNMENTS

| Service | Port | Command |
|---------|------|---------|
| core-engine API | 3001 | `npm run dev` |
| portal-hq | 5174 | `npm run dev` |
| portal-franchise | 5175 | `npm run dev` |
| portal-driver | 5176 | `npm run dev` |
| portal-customer | 5177 | `npm run dev` |

---

## 4. TECHNOLOGY STACK

### Frontend (All Portals)
| Technology | Purpose |
|------------|---------|
| React 18+ | UI framework |
| Vite | Build tool |
| CSS Modules | Scoped styling |
| React Router | Navigation |

### Backend (Core Engine)
| Technology | Purpose |
|------------|---------|
| Node.js | Runtime |
| Express.js | API framework |
| PostgreSQL | Database (Neon serverless) |
| Prisma | ORM |
| Socket.io | Real-time events |
| JWT | Authentication |

---

## 5. DATA FLOW

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Portal Apps    │────▶│  Core Engine    │────▶│   PostgreSQL    │
│  (React)        │◀────│  (Express.js)   │◀────│   (Neon)        │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                       │
        │                       │
        ▼                       ▼
┌─────────────────┐     ┌─────────────────┐
│  @stafull/shared│     │  Socket.io      │
│  (Design System)│     │  (Real-time)    │
└─────────────────┘     └─────────────────┘
```

### Communication Types
| Type | Use Case |
|------|----------|
| REST API | Standard CRUD operations |
| WebSocket | Real-time updates (tracking, status) |
| Shared Package | Design tokens, components |

---

## 6. MULTI-TENANT ISOLATION

All data scoped by `franchiseId`:
- Users belong to ONE franchise
- All queries filter by franchise
- Holdings admin sees ALL franchises
- Franchise users see ONLY their data

---

## 7. ROLE HIERARCHY

| Role | Level | Access |
|------|-------|--------|
| holdings_admin | 100 | All franchises |
| franchise_owner | 80 | Own franchise |
| manager | 60 | Operations |
| driver | 40 | Own routes |
| employer | 30 | Own employees |
| customer | 20 | Own account |
| employee | 20 | Own account |
| investor | 10 | Read-only |
| sba_lender | 10 | Read-only |

---

## 8. AUTHENTICATION

### JWT Tokens
- Access Token: 15 minutes expiry
- Refresh Token: 7 days expiry
- Stored in localStorage (access) and httpOnly cookie (refresh)

### API Response Format
```json
// Success
{
  "success": true,
  "data": { ... },
  "message": "Optional message"
}

// Error
{
  "error": "Human-readable message",
  "code": "ERROR_CODE"
}
```

---

## 9. DATABASE SCHEMA

### Core Entities
```
User
├── Customer (residential, b2b, b2c)
├── Driver
├── Employee (HR records)
└── Employer

Franchise
├── Territory
├── Vehicle
│   └── Tank
├── Route
│   └── Delivery
└── Subscription
```

### Key Tables
| Table | Purpose |
|-------|---------|
| users | All user accounts |
| franchises | Franchise records |
| customers | Customer data |
| drivers | Driver profiles |
| vehicles | Fleet vehicles |
| tanks | Vehicle tanks |
| deliveries | Delivery records |
| routes | Route definitions |
| subscriptions | Customer subscriptions |

---

## 10. API ENDPOINTS

### Base URL
- Development: `http://localhost:3001/api`
- Production: `https://api.stafull.com/api`

### Resource Endpoints
| Resource | Endpoints |
|----------|-----------|
| /api/auth | login, refresh, logout, me |
| /api/customers | CRUD + stats |
| /api/drivers | CRUD + location + mode |
| /api/vehicles | CRUD + tanks |
| /api/deliveries | CRUD + status |
| /api/routes | CRUD + optimization |

### WebSocket Events
| Event | Direction | Description |
|-------|-----------|-------------|
| driver:location | Client→Server | GPS update |
| driver:mode | Client→Server | Mode change |
| delivery:status | Client→Server | Status update |
| *:update | Server→Client | Broadcast changes |

---

## 11. DEPLOYMENT

### Development
| Component | Location |
|-----------|----------|
| All services | localhost |
| Database | Neon (cloud) |

### Production (Planned)
| Component | Provider |
|-----------|----------|
| Frontend | Vercel |
| Backend | Railway |
| Database | Neon |
| CDN | CloudFlare |

---

## 12. ENVIRONMENT VARIABLES

### Portal Apps
```env
VITE_API_URL=http://localhost:3001/api
```

### Core Engine
```env
DATABASE_URL=postgresql://...
JWT_SECRET=...
JWT_REFRESH_SECRET=...
PORT=3001
```

---

## 13. PACKAGE DEPENDENCIES

```
All Portals
  └── @stafull/shared (file:../stafull-shared)
  └── core-engine API (http://localhost:3001)
```

### Import Pattern
```javascript
// From shared package
import { Button, Card } from '@stafull/shared/components';
import '@stafull/shared/styles';
```

---

## 14. VEHICLE SPECIFICATIONS

### Model
- **2026 BrightDrop 400 2WD**
- Payload: 3,710 lbs

### 8-Tank Configuration
| Fuel | Tanks | Capacity | Notes |
|------|-------|----------|-------|
| Gas | 3 × 100gal | 300gal | Must stay under 1000 lbs combined |
| Diesel | 4 × 100gal | 400gal | |
| DEF | 1 × 100gal | 100gal | |
| **Total** | 8 tanks | 670gal | |

### FMCSA Compliance
- Diesel in non-bulk containers (<119 gal each) = **combustible** (not flammable)
- No hazmat regulations apply
- No CDL hazmat endorsement required
- No placards required

---

## 15. LEGAL

- **Owner:** Donald B. Havery (NEVER "Don" or "Don Havery")
- **Entity:** StaFull Holdings LLC (Delaware)
- All customer data and IP owned by HQ

---

**THIS FILE IS ENFORCED. NO EXCEPTIONS.**
